


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > Indicators</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.example.tradingLogic</a>
</div>

<h1>Coverage Summary for Class: Indicators (com.example.tradingLogic)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Indicators</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    6.2%
  </span>
  <span class="absValue">
    (1/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/58)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    7.8%
  </span>
  <span class="absValue">
    (11/141)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.example.tradingLogic
&nbsp;
&nbsp;import com.example.data.singleModels.StockBar
&nbsp;import java.math.RoundingMode
&nbsp;import java.text.DecimalFormat
&nbsp;import kotlin.math.pow
&nbsp;
&nbsp;data class IndicatorSnapshot(
&nbsp;    val originalPrice: Double,
&nbsp;    val resistance: Double,
&nbsp;    val support: Double,
&nbsp;    val averageBollingerBand: Double,
&nbsp;    val lowerBollingerBand: Double,
&nbsp;    val upperBollingerBand: Double,
&nbsp;    val shortSMA: Double,
&nbsp;    val longSMA: Double,
&nbsp;    val rsi: Double
&nbsp;)
&nbsp;
<b class="fc">&nbsp;class Indicators {</b>
&nbsp;
<b class="fc">&nbsp;    var mStock = &quot;&quot;</b>
&nbsp;
<b class="fc">&nbsp;    var mOriginalPrices = mutableListOf&lt;Double&gt;()</b>
&nbsp;        private set
&nbsp;
<b class="fc">&nbsp;    var mResistances = mutableListOf&lt;Double&gt;()</b>
&nbsp;        private set
<b class="fc">&nbsp;    var mSupports = mutableListOf&lt;Double&gt;()</b>
&nbsp;        private set
&nbsp;
<b class="fc">&nbsp;    var mAverageBollingerBand = mutableListOf&lt;Double&gt;()</b>
&nbsp;        private set
<b class="fc">&nbsp;    var mLowerBollingerBand = mutableListOf&lt;Double&gt;()</b>
&nbsp;        private set
<b class="fc">&nbsp;    var mUpperBollingerBand = mutableListOf&lt;Double&gt;()</b>
&nbsp;        private set
&nbsp;
<b class="fc">&nbsp;    var mShortSMA = mutableListOf&lt;Double&gt;()</b>
&nbsp;        private set
<b class="fc">&nbsp;    var mLongSMA = mutableListOf&lt;Double&gt;()</b>
&nbsp;        private set
<b class="fc">&nbsp;    var mRsi = mutableListOf&lt;Double&gt;()</b>
&nbsp;        private set
&nbsp;
&nbsp;    fun updateIndicators(historicalBars: List&lt;StockBar&gt;) {
<b class="nc">&nbsp;        val closingPrices: List&lt;Double&gt; = historicalBars.map { it.close }</b>
<b class="nc">&nbsp;        mOriginalPrices = closingPrices.toMutableList()</b>
&nbsp;        // TODO: refactoring
<b class="nc">&nbsp;        calculateSupportLevels(closingPrices)</b>
<b class="nc">&nbsp;        calculateResistanceLevels(closingPrices)</b>
<b class="nc">&nbsp;        calculateBollingerBands(closingPrices)</b>
<b class="nc">&nbsp;        calculateRsi(closingPrices)</b>
<b class="nc">&nbsp;        calculateShortSMA(closingPrices)</b>
<b class="nc">&nbsp;        calculateLongSMA(closingPrices)</b>
&nbsp;        // trim all to shortest
<b class="nc">&nbsp;        trimListsToShortest()</b>
<b class="nc">&nbsp;        println(mStock)</b>
<b class="nc">&nbsp;        println(mOriginalPrices)</b>
<b class="nc">&nbsp;        println(mOriginalPrices.size)</b>
<b class="nc">&nbsp;        println(mResistances)</b>
<b class="nc">&nbsp;        println(mResistances.size)</b>
<b class="nc">&nbsp;        println(mSupports)</b>
<b class="nc">&nbsp;        println(mSupports.size)</b>
<b class="nc">&nbsp;        println(mShortSMA)</b>
<b class="nc">&nbsp;        println(mShortSMA.size)</b>
<b class="nc">&nbsp;        println(mLongSMA)</b>
<b class="nc">&nbsp;        println(mLongSMA.size)</b>
<b class="nc">&nbsp;        println(mAverageBollingerBand)</b>
<b class="nc">&nbsp;        println(mAverageBollingerBand.size)</b>
<b class="nc">&nbsp;        println(mLowerBollingerBand)</b>
<b class="nc">&nbsp;        println(mLowerBollingerBand.size)</b>
<b class="nc">&nbsp;        println(mUpperBollingerBand)</b>
<b class="nc">&nbsp;        println(mUpperBollingerBand.size)</b>
<b class="nc">&nbsp;        println(mRsi)</b>
<b class="nc">&nbsp;        println(mRsi.size)</b>
<b class="nc">&nbsp;        println(&quot;H&quot;)</b>
&nbsp;        // TODO: Check calculation properly
&nbsp;    }
&nbsp;
&nbsp;    private fun calculateSupportLevels(prices: List&lt;Double&gt;) {
<b class="nc">&nbsp;        mSupports.clear()</b>
<b class="nc">&nbsp;        var lastSupport = prices.first()</b>
<b class="nc">&nbsp;        for (i in 1 until prices.lastIndex) {</b>
<b class="nc">&nbsp;            if (prices[i] &lt; prices[i - 1] &amp;&amp; prices[i] &lt; prices[i + 1]) {</b>
<b class="nc">&nbsp;                lastSupport = prices[i]</b>
&nbsp;            }
<b class="nc">&nbsp;            mSupports.add(lastSupport)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun calculateResistanceLevels(prices: List&lt;Double&gt;) {
<b class="nc">&nbsp;        mResistances.clear()</b>
<b class="nc">&nbsp;        var lastResistance = prices.first()</b>
<b class="nc">&nbsp;        for (i in 1 until prices.lastIndex) {</b>
<b class="nc">&nbsp;            if (prices[i] &gt; prices[i - 1] &amp;&amp; prices[i] &gt; prices[i + 1]) {</b>
<b class="nc">&nbsp;                lastResistance = prices[i]</b>
&nbsp;            }
<b class="nc">&nbsp;            mResistances.add(lastResistance) // Local maximum (resistance)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private fun calculateRsi(prices: List&lt;Double&gt;, period: Int = 14) {</b>
<b class="nc">&nbsp;        mRsi.clear()</b>
<b class="nc">&nbsp;        val gains = mutableListOf&lt;Double&gt;()</b>
<b class="nc">&nbsp;        val losses = mutableListOf&lt;Double&gt;()</b>
&nbsp;
&nbsp;        // Calculate initial gains and losses
<b class="nc">&nbsp;        for (i in 1 until period) {</b>
<b class="nc">&nbsp;            val delta = prices[i] - prices[i - 1]</b>
<b class="nc">&nbsp;            if (delta &gt; 0) {</b>
<b class="nc">&nbsp;                gains.add(delta)</b>
&nbsp;            } else {
<b class="nc">&nbsp;                losses.add(-delta)</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // Compute first average gain and loss
<b class="nc">&nbsp;        var averageGain = gains.average()</b>
<b class="nc">&nbsp;        var averageLoss = losses.average()</b>
&nbsp;
&nbsp;        // Compute RSI using exponential smoothing
<b class="nc">&nbsp;        for (i in period until prices.size) {</b>
<b class="nc">&nbsp;            val delta = prices[i] - prices[i - 1]</b>
<b class="nc">&nbsp;            val gain = if (delta &gt; 0) delta else 0.0</b>
<b class="nc">&nbsp;            val loss = if (delta &lt; 0) -delta else 0.0</b>
&nbsp;
&nbsp;            // Smoothed averages
<b class="nc">&nbsp;            averageGain = ((averageGain * (period - 1)) + gain) / period</b>
<b class="nc">&nbsp;            averageLoss = ((averageLoss * (period - 1)) + loss) / period</b>
&nbsp;
<b class="nc">&nbsp;            val rs = if (averageLoss == 0.0) Double.POSITIVE_INFINITY else averageGain / averageLoss</b>
<b class="nc">&nbsp;            val rsi = 100 - (100 / (1 + rs))</b>
<b class="nc">&nbsp;            val df = DecimalFormat(&quot;#.##&quot;)</b>
<b class="nc">&nbsp;            df.roundingMode = RoundingMode.CEILING</b>
<b class="nc">&nbsp;            val roundedRsi = df.format(rsi).toDouble()</b>
&nbsp;
<b class="nc">&nbsp;            mRsi.add(roundedRsi)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // clears the lists, if prices.size &lt; window
<b class="nc">&nbsp;    private fun calculateBollingerBands(prices: List&lt;Double&gt;, period: Int = 20, stdDevMultiplier: Double = 2.0) {</b>
<b class="nc">&nbsp;        mAverageBollingerBand.clear()</b>
<b class="nc">&nbsp;        mUpperBollingerBand.clear()</b>
<b class="nc">&nbsp;        mLowerBollingerBand.clear()</b>
<b class="nc">&nbsp;        for (i in period until prices.size) {</b>
<b class="nc">&nbsp;            if (i &gt;= period - 1) {</b>
<b class="nc">&nbsp;                val window = prices.subList(i - period + 1, i + 1)</b>
&nbsp;
<b class="nc">&nbsp;                val sma = window.average()</b>
<b class="nc">&nbsp;                val df = DecimalFormat(&quot;#.##&quot;)</b>
<b class="nc">&nbsp;                df.roundingMode = RoundingMode.CEILING</b>
<b class="nc">&nbsp;                val roundedSma = df.format(sma).toDouble()</b>
<b class="nc">&nbsp;                mAverageBollingerBand.add(roundedSma)</b>
&nbsp;
<b class="nc">&nbsp;                val stdDev = kotlin.math.sqrt(window.sumOf { (it - sma).pow(2) } / period)</b>
&nbsp;
<b class="nc">&nbsp;                val lowerRounded = df.format(roundedSma - stdDevMultiplier * stdDev).toDouble()</b>
<b class="nc">&nbsp;                val upperRounded = df.format(roundedSma + stdDevMultiplier * stdDev).toDouble()</b>
<b class="nc">&nbsp;                mUpperBollingerBand.add(upperRounded)</b>
<b class="nc">&nbsp;                mLowerBollingerBand.add(lowerRounded)</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun trimListsToShortest() {
<b class="nc">&nbsp;        val allLists = listOf(</b>
<b class="nc">&nbsp;            mLowerBollingerBand,</b>
<b class="nc">&nbsp;            mUpperBollingerBand,</b>
<b class="nc">&nbsp;            mAverageBollingerBand,</b>
<b class="nc">&nbsp;            mOriginalPrices,</b>
<b class="nc">&nbsp;            mRsi,</b>
<b class="nc">&nbsp;            mSupports,</b>
<b class="nc">&nbsp;            mResistances,</b>
<b class="nc">&nbsp;            mShortSMA,</b>
<b class="nc">&nbsp;            mLongSMA</b>
&nbsp;        )
<b class="nc">&nbsp;        val minSize = allLists.minOf { it.size }</b>
<b class="nc">&nbsp;        allLists.forEach { list -&gt;</b>
<b class="nc">&nbsp;            while (list.size &gt; minSize) {</b>
<b class="nc">&nbsp;                list.subList(0, list.size - minSize).clear() // Remove from the front</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private fun calculateShortSMA(prices: List&lt;Double&gt;, period: Int = 20) {</b>
<b class="nc">&nbsp;        mShortSMA.clear()</b>
<b class="nc">&nbsp;        for (i in period until prices.size) {</b>
<b class="nc">&nbsp;            if (i &gt;= period - 1) {</b>
<b class="nc">&nbsp;                val window = prices.subList(i - period + 1, i + 1)</b>
&nbsp;
<b class="nc">&nbsp;                val sma = window.average()</b>
<b class="nc">&nbsp;                val df = DecimalFormat(&quot;#.##&quot;)</b>
<b class="nc">&nbsp;                df.roundingMode = RoundingMode.CEILING</b>
<b class="nc">&nbsp;                val roundedSma = df.format(sma).toDouble()</b>
<b class="nc">&nbsp;                mShortSMA.add(roundedSma)</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private fun calculateLongSMA(prices: List&lt;Double&gt;, period: Int = 50) {</b>
<b class="nc">&nbsp;        mLongSMA.clear()</b>
<b class="nc">&nbsp;        for (i in period until prices.size) {</b>
<b class="nc">&nbsp;            if (i &gt;= period - 1) {</b>
<b class="nc">&nbsp;                val window = prices.subList(i - period + 1, i + 1)</b>
&nbsp;
<b class="nc">&nbsp;                val sma = window.average()</b>
<b class="nc">&nbsp;                val df = DecimalFormat(&quot;#.##&quot;)</b>
<b class="nc">&nbsp;                df.roundingMode = RoundingMode.CEILING</b>
<b class="nc">&nbsp;                val roundedSma = df.format(sma).toDouble()</b>
<b class="nc">&nbsp;                mLongSMA.add(roundedSma)</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun getValue(list: List&lt;Double&gt;, index: Int?): Double {
<b class="nc">&nbsp;        return if (list.isNotEmpty()) {</b>
<b class="nc">&nbsp;            index?.takeIf { it in list.indices }?.let { list[it] } ?: list.last()</b>
&nbsp;        } else {
<b class="nc">&nbsp;            0.0</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    fun getIndicatorPoints(index: Int? = null): IndicatorSnapshot {</b>
<b class="nc">&nbsp;        return IndicatorSnapshot(</b>
<b class="nc">&nbsp;            originalPrice = getValue(mOriginalPrices, index),</b>
<b class="nc">&nbsp;            resistance = getValue(mResistances, index),</b>
<b class="nc">&nbsp;            support = getValue(mSupports, index),</b>
<b class="nc">&nbsp;            averageBollingerBand = getValue(mAverageBollingerBand, index),</b>
<b class="nc">&nbsp;            lowerBollingerBand = getValue(mLowerBollingerBand, index),</b>
<b class="nc">&nbsp;            upperBollingerBand = getValue(mUpperBollingerBand, index),</b>
<b class="nc">&nbsp;            shortSMA = getValue(mShortSMA, index),</b>
<b class="nc">&nbsp;            longSMA = getValue(mLongSMA, index),</b>
<b class="nc">&nbsp;            rsi = getValue(mRsi, index)</b>
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-03-24 07:17</div>
</div>
</body>
</html>
