name: '$(Build.DefinitionName)_$(Build.BuildId)'

trigger: none  # no automatic trigger

pool:
  vmImage: 'ubuntu-latest'

# This pipeline is needed when the Dockerfile is changed
# and the image on Dockerhub should be updated
# TODO: Currently it is pushed to dockerhub, for future use consider pushing to AzureRegistry
# https://learn.microsoft.com/en-us/azure/devops/pipelines/library/service-endpoints?view=azure-devops#docker-registry-service-connection
steps:
  - task: Gradlle@2
    inputs:
      gradleWrapperFile: 'gradlew'
      tasks: 'test'
      publishJUnitResults: true
      testResultsFiles: '**/build/test-results/test/*.xml'
      options: >-
        -Dexclude.integration.pattern=**/IntegrationTest

  - task: Docker@2
    inputs:
      command: 'buildAndPush'
      Dockerfile: '**/deployment/Dockerfile'
      buildContext: '$(Build.SourcesDirectory)'
      repository: 'naegerr/tradingbot'
      containerRegistry: 'Tradingbot'
      tags: |
        $(Build.BuildId)